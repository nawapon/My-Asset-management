<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>แจ้งซ่อมครุภัณฑ์</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body class="hold-transition layout-top-nav">
<div class="wrapper">
  <div class="content-wrapper">
    <div class="content-header">
      <div class="container">
        <div class="row mb-2">
          <div class="col-sm-6"><h1 class="m-0"> <i class="fas fa-qrcode"></i> แจ้งซ่อมครุภัณฑ์</h1></div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="container">
        <div class="row">
          <div class="col-md-8 offset-md-2">
            
            <div id="loading-card" class="card card-primary card-outline text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-3">กำลังโหลดข้อมูลครุภัณฑ์...</p>
            </div>

            <div id="details-card" class="card card-primary card-outline" style="display: none;">
                <div class="card-header"><h3 class="card-title" id="details-asset-number"></h3></div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">ชื่ออุปกรณ์</dt><dd class="col-sm-8" id="details-name"></dd>
                        <dt class="col-sm-4">ประเภท</dt><dd class="col-sm-8" id="details-type"></dd>
                        <dt class="col-sm-4">สถานที่</dt><dd class="col-sm-8" id="details-location"></dd>
                        <dt class="col-sm-4">สถานะปัจจุบัน</dt><dd class="col-sm-8" id="details-status"></dd>
                    </dl>
                </div>
            </div>

            <div id="form-card" class="card card-success card-outline" style="display: none;">
                <div class="card-header"><h3 class="card-title">กรอกรายละเอียดเพื่อแจ้งซ่อม</h3></div>
                <form id="publicRepairForm">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="reporterName">ชื่อผู้แจ้ง</label>
                            <input type="text" id="reporterName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="problemDescription">รายละเอียดปัญหา</label>
                            <textarea id="problemDescription" class="form-control" rows="4" required></textarea>
                        </div>
                        <div id="form-message" class="message"></div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-success">ส่งเรื่องแจ้งซ่อม</button>
                    </div>
                </form>
            </div>
            
            <div id="success-card" class="card card-success" style="display: none;">
                <div class="card-header"><h3 class="card-title">สำเร็จ!</h3></div>
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h4>ส่งเรื่องแจ้งซ่อมเรียบร้อยแล้ว</h4>
                    <p id="success-message"></p>
                </div>
            </div>

            <div id="error-card" class="card card-danger" style="display: none;">
                 <div class="card-header"><h3 class="card-title">เกิดข้อผิดพลาด</h3></div>
                 <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                    <h4 id="error-message"></h4>
                 </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const assetNumber = urlParams.get('asset');
    
    function displayMessage(element, message, isSuccess) {
        const alertClass = isSuccess ? 'alert alert-success' : 'alert alert-danger';
        element.text(message).removeClass('alert-success alert-danger').addClass(alertClass).show();
    }

    if (!assetNumber) {
        $('#loading-card').hide();
        $('#error-message').text('ไม่พบหมายเลขครุภัณฑ์ใน URL');
        $('#error-card').show();
        return;
    }

    // Fetch equipment details
    $.ajax({
        url: `/api/public/equipment/${assetNumber}`,
        method: 'GET',
        success: function(details) {
            $('#loading-card').hide();
            $('#details-asset-number').text(`เลขครุภัณฑ์: ${assetNumber}`);
            $('#details-name').text(details.name || '-');
            $('#details-type').text(details.type || '-');
            $('#details-location').text(details.location || '-');
            $('#details-status').html(`<span class="badge badge-info">${details.status || '-'}</span>`);
            $('#details-card, #form-card').slideDown();
        },
        error: function(jqXHR) {
            $('#loading-card').hide();
            const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'ไม่สามารถโหลดข้อมูลได้';
            $('#error-message').text(errorMsg);
            $('#error-card').show();
        }
    });

    // Handle form submission
    $('#publicRepairForm').on('submit', function(e) {
        e.preventDefault();
        const reporterName = $('#reporterName').val();
        const problemDescription = $('#problemDescription').val();

        $.ajax({
            url: '/api/public/repairs',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ assetNumber, reporterName, problemDescription }),
            success: function(response) {
                $('#details-card, #form-card').hide();
                $('#success-message').text(response.message);
                $('#success-card').show();
            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'เกิดข้อผิดพลาด';
                displayMessage($('#form-message'), errorMsg, false);
            }
        });
    });
});
</script>
</body>
</html>
